{% extends 'base.html' %}

{% block content %}
  <h4 class="mb-4">Choose a Resume</h4>

  <!-- Upload Box -->

  <div class="card mb-4">
    <div class="card-body">
      <div class="muted-label mb-2">Upload a new resume</div>

      <div class="d-flex gap-2">
        <input id="resumeFile" class="form-control" type="file" accept=".pdf,.doc,.docx" />
        <button class="btn btn-primary" onclick="uploadResume()">Upload</button>
      </div>

      <div id="uploadStatus" class="muted-label mt-2"></div>
    </div>
  </div>

  <!-- Resume List -->

  {% if resumes %}
    <div id="resumeList" class="vstack gap-3">
      {% for r in resumes %}
        <div class="card resume-card" data-id="{{ r.id }}">
          <div class="card-body d-flex justify-content-between align-items-center">
            <div>
              <div class="file-name">{{ r.original_filename }}</div>
              <div class="muted-label">Resume ID {{ r.id }}</div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>

    <div class="mt-4 text-end">
      <a id="continueBtn" class="btn btn-primary disabled">Continue</a>
    </div>
  {% else %}
    <div class="text-muted">No resumes uploaded yet</div>
  {% endif %}

  <script>
    var selectedResumeId = null
    
    var cards = document.querySelectorAll('.resume-card')
    var continueBtn = document.getElementById('continueBtn')
    
    for (var i = 0; i < cards.length; i++) {
      cards[i].addEventListener('click', selectResumeCard)
    }
    
    continueBtn.addEventListener('click', continueToNext)
    
    function continueToNext(event) {
      event.preventDefault()
    
      if (selectedResumeId !== null) {
        window.location.href = `/ui/job-description/${selectedResumeId}`
      }
    }
    
    function selectResumeCard(event) {
      // Remove previous selection
      for (var j = 0; j < cards.length; j++) {
        cards[j].classList.remove('selected')
      }
    
      // Mark clicked card
      this.classList.add('selected')
    
      // Store id
      selectedResumeId = this.getAttribute('data-id')
    
      // Enable button
      continueBtn.classList.remove('disabled')
    }
    
    //-------------------------------------------------------------
    
    function uploadResume() {
      var fileInput = document.getElementById('resumeFile')
      var statusText = document.getElementById('uploadStatus')
    
      if (fileInput.files.length === 0) {
        statusText.innerText = 'Please choose a file first.'
        return
      }
    
      var file = fileInput.files[0]
    
      // Prepare multipart form data
      var formData = new FormData()
      formData.append('file', file) // IMPORTANT: must be 'file'
    
      // Create AJAX request
      var xhr = new XMLHttpRequest()
    
      xhr.open('POST', '/resume', true)
    
      statusText.innerText = 'Uploading...'
    
      xhr.onload = function () {
        if (xhr.status === 200 || xhr.status === 201) {
          // Parse response JSON
          var response = JSON.parse(xhr.responseText)
    
          statusText.innerText = 'Upload successful. Parsing...'
    
          // Step 2 â†’ call parse endpoint
          parseResume(response.id)
        } else {
          statusText.innerText = 'Upload failed.'
        }
      }
    
      xhr.onerror = function () {
        statusText.innerText = 'Network error.'
      }
    
      xhr.send(formData)
    }
    
    function parseResume(resumeId) {
      var xhr = new XMLHttpRequest()
    
      xhr.open('GET', `/resume/${resumeId}`, true)
    
      xhr.onload = function () {
        if (xhr.status === 200) {
          var statusText = document.getElementById('uploadStatus')
          statusText.innerText = 'Processing completed. Reloading...'
    
          // Give slight delay so user sees message
          setTimeout(function () {
            window.location.reload()
          }, 800)
        } else {
          var statusText = document.getElementById('uploadStatus')
          statusText.innerText = 'Parsing failed.'
        }
      }
    
      xhr.onerror = function () {
        var statusText = document.getElementById('uploadStatus')
        statusText.innerText = 'Network error during parsing.'
      }
    
      xhr.send()
    }
  </script>
{% endblock %}
