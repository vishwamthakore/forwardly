{% extends 'base.html' %}

{% block content %}
  <!-- Create Job Description -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="mb-2 file-name">Add Job Description</div>

      <textarea id="jdText" class="form-control mb-3" rows="6" placeholder="Paste the job description here..."></textarea>

      <div class="d-flex justify-content-between align-items-center">
        <div id="jdStatus" class="muted-label"></div>

        <button id="createJdBtn" class="btn btn-primary">Create Job Description</button>
      </div>
    </div>
  </div>

  {% if job_descriptions %}
    <div id="resumeList" class="vstack gap-3">
      {% for jd in job_descriptions %}
        <div class="card resume-card" data-id="{{ jd.id }}">
          <div class="card-body d-flex justify-content-between align-items-center">
            <div>
              <div class="file-name">{{ jd.name }}</div>
              <div class="muted-label">Job Description ID {{ jd.id }}</div>
              <div class="muted-label">Created At {{ jd.created_at }}</div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
    <div class="mt-4 text-end">
      <a id="continueBtn" class="btn btn-primary disabled">Continue</a>
    </div>
  {% else %}
    <div class="text-muted">No Job Descriptions uploaded yet</div>
  {% endif %}

  <div>
      Selected Resume <span id="resume-id">{{ resume_id }}</span>
  </div>

  <script>
    // -----------------------------------------------------------------------------
    var selectedJobId = null
    
    var cards = document.querySelectorAll('.resume-card')
    var continueBtn = document.getElementById('continueBtn')
    var resumeId = document.getElementById('resume-id').innerHTML
    
    var createBtn = document.getElementById('createJdBtn')
    var jdTextBox = document.getElementById('jdText')
    var jdStatus = document.getElementById('jdStatus')
    
    createBtn.addEventListener('click', createJobDescription)
    
    for (var i = 0; i < cards.length; i++) {
      cards[i].addEventListener('click', selectJobCard)
    }
    
    continueBtn.addEventListener('click', continueToNext)
    
    function continueToNext(event) {
      event.preventDefault()
    
      if (selectedJobId !== null) {
        window.location.href = `/ui/analysis/${resumeId}/${selectedJobId}`
      }
    }
    
    function selectJobCard(event) {
      // Remove previous selection
      for (var j = 0; j < cards.length; j++) {
        cards[j].classList.remove('selected')
      }
    
      // Mark clicked card
      this.classList.add('selected')
    
      // Store id
      selectedJobId = this.getAttribute('data-id')
    
      // Enable button
      continueBtn.classList.remove('disabled')
    }
    
    // -----------------------------------------------------------------------------
    // Create job description
    
    function createJobDescription() {
      var text = jdTextBox.value.trim()
    
      if (text.length === 0) {
        jdStatus.textContent = 'Please paste a job description.'
        return
      }
    
      jdStatus.textContent = 'Creating...'
      createBtn.classList.add('disabled')
    
      var xhr = new XMLHttpRequest()
    
      xhr.open('POST', '/job-description/', true)
      xhr.setRequestHeader('Content-Type', 'application/json')
    
      xhr.onload = function () {
        if (xhr.status === 200 || xhr.status === 201) {
          jdStatus.textContent = 'Created successfully. Reloading...'
          window.location.reload()
        } else {
          jdStatus.textContent = 'Error creating job description.'
          createBtn.classList.remove('disabled')
        }
      }
    
      xhr.onerror = function () {
        jdStatus.textContent = 'Network error.'
        createBtn.classList.remove('disabled')
      }
    
      var payload = JSON.stringify({
        text: text
      })
    
      xhr.send(payload)
    }
  </script>
{% endblock %}
